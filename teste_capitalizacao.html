<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Capitalização de Juros</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-case { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-case.success { border-color: #4CAF50; background: #f8fff8; }
        .test-case.error { border-color: #f44336; background: #fff8f8; }
        .result { margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 3px; font-family: monospace; }
        .log { color: #666; font-size: 12px; }
        h1 { color: #333; text-align: center; }
        h3 { color: #555; margin-top: 0; }
        .summary { text-align: center; margin: 20px 0; font-size: 18px; }
        .pass { color: #4CAF50; }
        .fail { color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Teste de Capitalização de Juros - Empréstimos</h1>
        <div class="summary" id="summary"></div>
        <div id="test-results"></div>
    </div>

    <script type="module">
        // Funções auxiliares do sistema (simuladas para teste)
        function getFortalezaParts(date = new Date()) {
            try {
                const parts = new Intl.DateTimeFormat('pt-BR', {
                    timeZone: 'America/Fortaleza', year: 'numeric', month: '2-digit', day: '2-digit'
                }).formatToParts(date)
                const map = Object.fromEntries(parts.map(p => [p.type, p.value]))
                return { year: Number(map.year), month: Number(map.month), day: Number(map.day) }
            } catch {
                const d = new Date(date)
                return { year: d.getFullYear(), month: d.getMonth() + 1, day: d.getDate() }
            }
        }

        function ymStr({ year, month }) {
            return `${year}-${String(month).padStart(2, '0')}`
        }

        function listMonthsBetween(fromYm, toYm) {
            if (!fromYm || !toYm) return []
            const monthIndex = (ym) => {
                const [y, m] = ym.split('-').map(Number)
                return y * 12 + (m - 1)
            }
            const res = []
            let i = monthIndex(fromYm) + 1
            const end = monthIndex(toYm)
            while (i <= end) {
                const y = Math.floor(i / 12)
                const m = (i % 12) + 1
                res.push(`${y}-${String(m).padStart(2, '0')}`)
                i++
            }
            return res
        }

        function sumInterestPaidForMonth(pays, ym) {
            if (!Array.isArray(pays) || !ym) return 0
            let total = 0
            for (const p of pays) {
                try {
                    const d = p.data_pagamento ? new Date(p.data_pagamento) : (p.created_at ? new Date(p.created_at) : null)
                    if (!d) continue
                    const parts = getFortalezaParts(d)
                    const currYm = ymStr(parts)
                    if (currYm === ym) {
                        total += Math.round(Number(p.juros_pago || 0) * 100)
                    }
                } catch {}
            }
            return total
        }

        // Função CORRIGIDA de capitalização
        function applyMonthlyCapitalizationIfDueTESTE(loan) {
            try {
                const pays = Array.isArray(loan.pays) ? loan.pays : []
                const today = getFortalezaParts(loan.testDate || new Date())
                const currentYm = ymStr(today)
                const day = Number(today.day || 1)
                
                let base = Number(loan.residualCents || 0)
                const rate = Number(loan.monthlyRatePct || 0)
                const key = `loan:lastCapYm:${loan.debtId || 'local'}`
                const lastCapYm = loan.lastCapYm || null
                
                const monthsToProcess = lastCapYm ? listMonthsBetween(lastCapYm, currentYm) : [currentYm]
                const trend = []
                const breakdown = []
                
                for (const ym of monthsToProcess) {
                    const isCurrent = ym === currentYm
                    const baseBefore = base
                    let expected = 0, paid = 0, unpaid = 0
                    
                    // CORREÇÃO: Deve capitalizar apenas após o dia 05 (dia > 5)
                    if (!isCurrent || day > 5) {
                        expected = Math.round(baseBefore * (rate / 100))
                        paid = sumInterestPaidForMonth(pays, ym)
                        unpaid = Math.max(0, expected - paid)
                        base = baseBefore + unpaid  // Sempre capitaliza se houver juros não pagos
                    } else {
                        expected = Math.round(baseBefore * (rate / 100))
                        paid = sumInterestPaidForMonth(pays, ym)
                        unpaid = Math.max(0, expected - paid)
                        base = baseBefore  // Antes do dia 05, apenas projeta
                    }
                    
                    const baseAfter = base
                    trend.push({ ym, residualCents: baseAfter })
                    breakdown.push({ ym, baseBefore, expected, paid, capitalized: unpaid, baseAfter })
                }
                
                return { 
                    residualCentsDisplay: base, 
                    residualTrend: trend, 
                    capitalizationBreakdown: breakdown,
                    debug: { day, currentYm, lastCapYm }
                }
            } catch (err) {
                console.error('Erro na capitalização:', err)
                return { 
                    residualCentsDisplay: loan.residualCents, 
                    residualTrend: [], 
                    capitalizationBreakdown: [],
                    error: err.message
                }
            }
        }

        // Função ANTIGA (com erro) para comparação
        function applyMonthlyCapitalizationIfDueANTIGA(loan) {
            try {
                const pays = Array.isArray(loan.pays) ? loan.pays : []
                const today = getFortalezaParts(loan.testDate || new Date())
                const currentYm = ymStr(today)
                const day = Number(today.day || 1)
                
                let base = Number(loan.residualCents || 0)
                const rate = Number(loan.monthlyRatePct || 0)
                const key = `loan:lastCapYm:${loan.debtId || 'local'}`
                const lastCapYm = loan.lastCapYm || null
                
                const monthsToProcess = lastCapYm ? listMonthsBetween(lastCapYm, currentYm) : [currentYm]
                const trend = []
                const breakdown = []
                
                for (const ym of monthsToProcess) {
                    const isCurrent = ym === currentYm
                    const baseBefore = base
                    let expected = 0, paid = 0, unpaid = 0
                    
                    // ERRO: Estava capitalizando a partir do dia 05 (>= 5)
                    if (!isCurrent || day >= 5) {
                        expected = Math.round(baseBefore * (rate / 100))
                        paid = sumInterestPaidForMonth(pays, ym)
                        unpaid = Math.max(0, expected - paid)
                        base = unpaid > 0 ? (baseBefore + unpaid) : baseBefore  // Só capitaliza se unpaid > 0
                    } else {
                        expected = Math.round(baseBefore * (rate / 100))
                        paid = sumInterestPaidForMonth(pays, ym)
                        unpaid = Math.max(0, expected - paid)
                        base = baseBefore
                    }
                    
                    const baseAfter = base
                    trend.push({ ym, residualCents: baseAfter })
                    breakdown.push({ ym, baseBefore, expected, paid, capitalized: unpaid, baseAfter })
                }
                
                return { 
                    residualCentsDisplay: base, 
                    residualTrend: trend, 
                    capitalizationBreakdown: breakdown,
                    debug: { day, currentYm, lastCapYm }
                }
            } catch (err) {
                console.error('Erro na capitalização antiga:', err)
                return { 
                    residualCentsDisplay: loan.residualCents, 
                    residualTrend: [], 
                    capitalizationBreakdown: [],
                    error: err.message
                }
            }
        }

        // Casos de teste
        const testCases = [
            {
                name: "Dia 04 - NÃO deve capitalizar",
                loan: {
                    residualCents: 100000, // R$ 1.000,00
                    monthlyRatePct: 10, // 10% ao mês
                    testDate: new Date('2024-01-04'), // Dia 4
                    lastCapYm: '2023-12',
                    pays: []
                },
                expectedCapitalization: 0
            },
            {
                name: "Dia 05 - NÃO deve capitalizar",
                loan: {
                    residualCents: 100000,
                    monthlyRatePct: 10,
                    testDate: new Date('2024-01-05'), // Dia 5
                    lastCapYm: '2023-12',
                    pays: []
                },
                expectedCapitalization: 0
            },
            {
                name: "Dia 06 - DEVE capitalizar",
                loan: {
                    residualCents: 100000,
                    monthlyRatePct: 10,
                    testDate: new Date('2024-01-06'), // Dia 6
                    lastCapYm: '2023-12',
                    pays: []
                },
                expectedCapitalization: 10000 // 10% de 100.000 centavos
            },
            {
                name: "Dia 10 - DEVE capitalizar",
                loan: {
                    residualCents: 100000,
                    monthlyRatePct: 10,
                    testDate: new Date('2024-01-10'), // Dia 10
                    lastCapYm: '2023-12',
                    pays: []
                },
                expectedCapitalization: 10000
            },
            {
                name: "Dia 06 com pagamento parcial - DEVE capitalizar diferença",
                loan: {
                    residualCents: 100000,
                    monthlyRatePct: 10,
                    testDate: new Date('2024-01-06'), // Dia 6
                    lastCapYm: '2023-12',
                    pays: [
                        { juros_pago: 50, data_pagamento: '2024-01-06' } // Pagou R$ 50,00 dos R$ 100,00
                    ]
                },
                expectedCapitalization: 5000 // R$ 50,00 restantes (10.000 - 5.000 = 5.000 centavos)
            }
        ]

        // Executar testes
        function runTests() {
            const resultsDiv = document.getElementById('test-results')
            let passed = 0
            let failed = 0

            testCases.forEach((testCase, index) => {
                const resultNovo = applyMonthlyCapitalizationIfDueTESTE(testCase.loan)
                const resultAntigo = applyMonthlyCapitalizationIfDueANTIGA(testCase.loan)
                
                const novoSaldo = resultNovo.residualCentsDisplay
                const antigoSaldo = resultAntigo.residualCentsDisplay
                const diferenca = novoSaldo - testCase.loan.residualCents
                
                const passou = diferenca === testCase.expectedCapitalization
                
                const testDiv = document.createElement('div')
                testDiv.className = `test-case ${passou ? 'success' : 'error'}`
                
                testDiv.innerHTML = `
                    <h3>Teste ${index + 1}: ${testCase.name}</h3>
                    <div class="log">
                        <strong>Data do teste:</strong> ${testCase.loan.testDate.toLocaleDateString('pt-BR')}<br>
                        <strong>Saldo inicial:</strong> R$ ${(testCase.loan.residualCents / 100).toFixed(2)}<br>
                        <strong>Taxa mensal:</strong> ${testCase.loan.monthlyRatePct}%<br>
                        <strong>Capitalização esperada:</strong> R$ ${(testCase.expectedCapitalization / 100).toFixed(2)}<br>
                        <strong>Resultado novo:</strong> R$ ${(diferenca / 100).toFixed(2)}<br>
                        <strong>Resultado antigo:</strong> R$ ${((antigoSaldo - testCase.loan.residualCents) / 100).toFixed(2)}
                    </div>
                    <div class="result">
                        <strong>Status:</strong> ${passou ? '✅ PASSOU' : '❌ FALHOU'}<br>
                        <strong>Novo saldo:</strong> R$ ${(novoSaldo / 100).toFixed(2)}<br>
                        <strong>Debug:</strong> Dia ${resultNovo.debug?.day}, Mês: ${resultNovo.debug?.currentYm}
                    </div>
                `
                
                resultsDiv.appendChild(testDiv)
                
                if (passou) {
                    passed++
                } else {
                    failed++
                }
            })

            // Resumo
            const summaryDiv = document.getElementById('summary')
            summaryDiv.innerHTML = `
                <span class="${failed === 0 ? 'pass' : 'fail'}">
                    ${passed} testes passaram, ${failed} falharam
                </span>
                <br>
                <small>Total: ${testCases.length} testes executados</small>
            `
        }

        // Executar quando a página carregar
        document.addEventListener('DOMContentLoaded', runTests)
    </script>
</body>
</html>